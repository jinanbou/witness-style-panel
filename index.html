<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Witness Stage Select</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: #222;
    color: white;
    font-family: sans-serif;
    user-select: none;
  }
  .screen {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .stage-select, .stage-view, .witness-view {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .stage-select.active,
  .stage-view.active,
  .witness-view.active {
    display: flex;
  }
  .stages {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }
  .stage-button {
    padding: 20px;
    background: #555;
    border: 2px solid #888;
    cursor: pointer;
  }
  .stage-button.locked {
    background: #333;
    color: #666;
    pointer-events: none;
  }
  #answerInput, #mapAnswerInput {
    margin-top: 20px;
    padding: 10px;
    font-size: 16px;
  }
  #imageDisplay {
    max-width: 80vw;
    max-height: 60vh;
    margin-bottom: 20px;
    border: 2px solid #888;
  }
</style>
</head>
<body>
<div class="screen stage-select active" id="stageSelect">
  <h2>ステージセレクト</h2>
  <div class="stages">
    <div class="stage-button" id="stage1">ステージ1</div>
    <div class="stage-button locked" id="stage2">ステージ2</div>
    <div class="stage-button locked" id="stage3">ステージ3</div>
  </div>
  <input type="text" id="mapAnswerInput" placeholder="マップの答えを入力" />
</div>

<div class="screen stage-view" id="stageView">
  <img id="imageDisplay" src="" alt="ステージ画像" />
  <input type="text" id="answerInput" placeholder="答えを入力" />
</div>

<div class="screen witness-view" id="witnessView">
  <iframe id="witnessFrame" src="witness.html" width="100%" height="100%" style="border: none;"></iframe>
</div>

<script>
  const stageSelect = document.getElementById('stageSelect');
  const stageView = document.getElementById('stageView');
  const witnessView = document.getElementById('witnessView');
  const witnessFrame = document.getElementById('witnessFrame');

  const imageDisplay = document.getElementById('imageDisplay');
  const answerInput = document.getElementById('answerInput');
  const mapAnswerInput = document.getElementById('mapAnswerInput');

  const stage1Btn = document.getElementById('stage1');
  const stage2Btn = document.getElementById('stage2');
  const stage3Btn = document.getElementById('stage3');

  let currentStage = 0;

  const stageData = [
    { image: 'image1.jpeg', answer: 'burglary' },
    { image: 'image2.png', answer: 'alley' },
    { image: 'image3.png', answer: 'fetching' }
  ];

  const mapAnswer = 'helps';
  let mapUnlocked = false;

  stage1Btn.addEventListener('click', () => enterStage(0));
  stage2Btn.addEventListener('click', () => enterStage(1));
  stage3Btn.addEventListener('click', () => enterStage(2));

  function enterStage(index) {
    currentStage = index;
    imageDisplay.src = stageData[index].image;
    stageSelect.classList.remove('active');
    stageView.classList.add('active');
  }

  answerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const userAnswer = answerInput.value.trim().toLowerCase();
      if (userAnswer === stageData[currentStage].answer) {
        if (currentStage === 0) stage2Btn.classList.remove('locked');
        if (currentStage === 1) stage3Btn.classList.remove('locked');
        if (currentStage === 2 && mapUnlocked) {
          stageView.classList.remove('active');
          witnessView.classList.add('active');
        } else {
          alert('正解！ステージセレクトに戻ります');
          stageView.classList.remove('active');
          stageSelect.classList.add('active');
        }
      } else {
        alert('不正解');
      }
    }
  });

  mapAnswerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const ans = mapAnswerInput.value.trim().toLowerCase();
      if (ans === mapAnswer) {
        alert('マップ解放！Witnessパネルが使えるようになりました');
        mapUnlocked = true;
        stage3Btn.textContent = 'Witness!';
      } else {
        alert('違います');
      }
    }
  });

  // メッセージ受信で戻る処理
  window.addEventListener('message', (event) => {
    if (event.data === 'backToStageSelect') {
      witnessView.classList.remove('active');
      stageSelect.classList.add('active');
    }
  });
</script>
</body>
</html>
