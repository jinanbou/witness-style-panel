<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>The Witness風 パネル線引き</title>
<style>
  body {
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    background: #111;
    color: white;
  }
  #video-container {
    margin-top: 20px;
    width: 640px;
    max-width: 90vw;
    height: 360px;
    background: black;
  }
  #video {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  #panels {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    width: 90vw;
    max-width: 640px;
    justify-content: center;
  }
  .panel {
    position: relative;
    width: 30%;
    aspect-ratio: 1 / 1;
    background: #222;
    border-radius: 8px;
    user-select: none;
    touch-action: none;
  }
  canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: 8px;
  }
</style>
</head>
<body>

<div id="video-container">
  <video id="video" controls autoplay muted>
    <source src="image1.jpeg" type="image/jpeg">
    Your browser does not support the video tag.
  </video>
</div>

<div id="panels">
  <div class="panel" data-video="image1.jpeg"><canvas></canvas></div>
  <div class="panel" data-video="image2.png"><canvas></canvas></div>
  <div class="panel" data-video="image3.png"><canvas></canvas></div>
</div>

<script>
(() => {
  const panels = document.querySelectorAll('.panel');
  const video = document.getElementById('video');

  let currentPanel = null;
  let isDrawing = false;
  let ctx = null;
  let startPoint = null;
  const allowedStart = [{x: 20, y: 20}, {x: 20, y: 20}, {x: 20, y: 20}]; //例：スタート丸の座標（各パネル同じ）

  // 初期描画で薄い線とスタート丸を描く関数
  function drawInitialLine(panel) {
    const canvas = panel.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(20, 20);
    ctx.lineTo(canvas.width - 20, 20);
    ctx.stroke();

    // スタートの丸
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(20, 20, 8, 0, Math.PI*2);
    ctx.fill();
  }

  panels.forEach(panel => {
    const canvas = panel.querySelector('canvas');
    canvas.width = canvas.clientWidth * devicePixelRatio;
    canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx = canvas.getContext('2d');
    ctx.scale(devicePixelRatio, devicePixelRatio);
    drawInitialLine(panel);

    // タッチ・マウス共通の位置取得関数
    function getPos(e) {
      let rect = canvas.getBoundingClientRect();
      let x, y;
      if (e.touches) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
      }
      return {x, y};
    }

    // 開始判定（スタート丸付近かどうか）
    function isNearStart(pos) {
      let dx = pos.x - 20;
      let dy = pos.y - 20;
      return Math.sqrt(dx*dx + dy*dy) < 15;
    }

    function startDraw(e) {
      e.preventDefault();
      const pos = getPos(e);
      if (!isNearStart(pos)) return;
      currentPanel = panel;
      isDrawing = true;
      ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      startPoint = pos;
    }
    function draw(e) {
      if (!isDrawing || currentPanel !== panel) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }
    function endDraw(e) {
      if (!isDrawing || currentPanel !== panel) return;
      e.preventDefault();
      isDrawing = false;
      video.src = panel.dataset.video;
    }

    // イベント登録（タッチとマウス）
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', endDraw);
  });
})();
</script>

</body>
</html>
